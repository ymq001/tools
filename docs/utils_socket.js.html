<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>utils/socket.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="utils.html">utils</a><ul class='methods'><li data-type='method'><a href="utils.html#isObject">isObject</a></li><li data-type='method'><a href="utils.html#isArray">isArray</a></li><li data-type='method'><a href="utils.html#isDate">isDate</a></li><li data-type='method'><a href="utils.html#isNumber">isNumber</a></li><li data-type='method'><a href="utils.html#isInteger">isInteger</a></li><li data-type='method'><a href="utils.html#isString">isString</a></li><li data-type='method'><a href="utils.html#isBoolean">isBoolean</a></li><li data-type='method'><a href="utils.html#isFunction">isFunction</a></li><li data-type='method'><a href="utils.html#isNull">isNull</a></li><li data-type='method'><a href="utils.html#isNil">isNil</a></li><li data-type='method'><a href="utils.html#isPlainObject">isPlainObject</a></li><li data-type='method'><a href="utils.html#hasOwn">hasOwn</a></li><li data-type='method'><a href="utils.html#unique">unique</a></li><li data-type='method'><a href="utils.html#extend">extend</a></li><li data-type='method'><a href="utils.html#freeze">freeze</a></li><li data-type='method'><a href="utils.html#copy">copy</a></li><li data-type='method'><a href="utils.html#getKeyValue">getKeyValue</a></li><li data-type='method'><a href="utils.html#setKeyValue">setKeyValue</a></li><li data-type='method'><a href="utils.html#toArray">toArray</a></li><li data-type='method'><a href="utils.html#toObject">toObject</a></li><li data-type='method'><a href="utils.html#uuid">uuid</a></li><li data-type='method'><a href="utils.html#getBrowser">getBrowser</a></li><li data-type='method'><a href="utils.html#getUriParams">getUriParams</a></li><li data-type='method'><a href="utils.html#getUriParamValue">getUriParamValue</a></li><li data-type='method'><a href="utils.html#saveLocal">saveLocal</a></li><li data-type='method'><a href="utils.html#getLocal">getLocal</a></li><li data-type='method'><a href="utils.html#getLocal2Json">getLocal2Json</a></li><li data-type='method'><a href="utils.html#removeLocal">removeLocal</a></li><li data-type='method'><a href="utils.html#saveCookie">saveCookie</a></li><li data-type='method'><a href="utils.html#getCookie">getCookie</a></li><li data-type='method'><a href="utils.html#removeCookie">removeCookie</a></li><li data-type='method'><a href="utils.html#clearCookie">clearCookie</a></li></ul></li><li><a href="protorypes.date.html">date</a><ul class='methods'><li data-type='method'><a href="protorypes.date.html#.format">format</a></li><li data-type='method'><a href="protorypes.date.html#.modDays">modDays</a></li><li data-type='method'><a href="protorypes.date.html#.modMinutes">modMinutes</a></li><li data-type='method'><a href="protorypes.date.html#.convertDateToTimeStamp">convertDateToTimeStamp</a></li><li data-type='method'><a href="protorypes.date.html#.convertTimeStampToDate">convertTimeStampToDate</a></li></ul></li><li><a href="protorypes.QT.html">QT</a><ul class='methods'><li data-type='method'><a href="protorypes.QT.html#.showLoading">showLoading</a></li></ul></li><li><a href="socket.socket.html">socket</a></li><li><a href="utils.map.default.html">default</a><ul class='members'><li data-type='member'><a href="utils.map.default.html#._map">_map</a></li><li data-type='member'><a href="utils.map.default.html#.Org">Org</a></li><li data-type='member'><a href="utils.map.default.html#.Rcu">Rcu</a></li><li data-type='member'><a href="utils.map.default.html#.Network">Network</a></li><li data-type='member'><a href="utils.map.default.html#.RingNet">RingNet</a></li><li data-type='member'><a href="utils.map.default.html#.Robot">Robot</a></li><li data-type='member'><a href="utils.map.default.html#.Smd">Smd</a></li></ul><ul class='methods'><li data-type='method'><a href="utils.map.default.html#getIcon">getIcon</a></li><li data-type='method'><a href="utils.map.default.html#setIcon">setIcon</a></li></ul></li><li><a href="utils.map.RManager.html">RManager</a><ul class='methods'><li data-type='method'><a href="utils.map.RManager.html#addOverlay">addOverlay</a></li><li data-type='method'><a href="utils.map.RManager.html#addOverlays">addOverlays</a></li><li data-type='method'><a href="utils.map.RManager.html#removerOverlay">removerOverlay</a></li><li data-type='method'><a href="utils.map.RManager.html#removeOverlays">removeOverlays</a></li><li data-type='method'><a href="utils.map.RManager.html#removeViewingOverlay">removeViewingOverlay</a></li><li data-type='method'><a href="utils.map.RManager.html#removeViewingOverlays">removeViewingOverlays</a></li><li data-type='method'><a href="utils.map.RManager.html#clearOverlays">clearOverlays</a></li><li data-type='method'><a href="utils.map.RManager.html#clearViewingOverlays">clearViewingOverlays</a></li><li data-type='method'><a href="utils.map.RManager.html#getViewingOverlaysByZoom">getViewingOverlaysByZoom</a></li><li data-type='method'><a href="utils.map.RManager.html#show">show</a></li><li data-type='method'><a href="utils.map.RManager.html#hide">hide</a></li><li data-type='method'><a href="utils.map.RManager.html#toggle">toggle</a></li><li data-type='method'><a href="utils.map.RManager.html#getOverlayBykey">getOverlayBykey</a></li><li data-type='method'><a href="utils.map.RManager.html#getOverlays">getOverlays</a></li></ul></li><li><a href="utils.map.RMarker.html">RMarker</a><ul class='methods'><li data-type='method'><a href="utils.map.RMarker.html#_preRenderContent">_preRenderContent</a></li><li data-type='method'><a href="utils.map.RMarker.html#_convertThemeToString">_convertThemeToString</a></li><li data-type='method'><a href="utils.map.RMarker.html#_renderPresetStyles">_renderPresetStyles</a></li><li data-type='method'><a href="utils.map.RMarker.html#enableDragging">enableDragging</a></li><li data-type='method'><a href="utils.map.RMarker.html#disableDragging">disableDragging</a></li><li data-type='method'><a href="utils.map.RMarker.html#isDraggable">isDraggable</a></li><li data-type='method'><a href="utils.map.RMarker.html#getPosition">getPosition</a></li><li data-type='method'><a href="utils.map.RMarker.html#setPosition">setPosition</a></li><li data-type='method'><a href="utils.map.RMarker.html#getAnchor">getAnchor</a></li><li data-type='method'><a href="utils.map.RMarker.html#setAnchor">setAnchor</a></li><li data-type='method'><a href="utils.map.RMarker.html#getContent">getContent</a></li><li data-type='method'><a href="utils.map.RMarker.html#setContent">setContent</a></li><li data-type='method'><a href="utils.map.RMarker.html#getWidth">getWidth</a></li><li data-type='method'><a href="utils.map.RMarker.html#setWidth">setWidth</a></li><li data-type='method'><a href="utils.map.RMarker.html#getHeight">getHeight</a></li><li data-type='method'><a href="utils.map.RMarker.html#setHeight">setHeight</a></li><li data-type='method'><a href="utils.map.RMarker.html#on">on</a></li><li data-type='method'><a href="utils.map.RMarker.html#off">off</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">utils/socket.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>let socketDefaults = {
  /**
   * 标识是否断开重连的开关, 默认开启
   */
  isReconnect: true,
  /**
   * 标识是否正在尝试开始重新连接
   */
  isRestart: false,
  /**
   * 标识是否正在尝试重新连接
   */
  _lockReconnect: false,
  /**
   * 标识socket实例
   */
  _socket: null,
  /**
   * 标识需要连接的ws地址
   */
  _host: '',
  /**
   * 标识该连接已注册的回调事件列表
   */
  _handles: {},
  /**
   * 标识连接打开时的执行函数
   */
  openHandles: function () {

  }
};

/**
 * socket基类
 * @private
 * @param {Object} opts 
 * @property {Boolean} isReconnect 标识是否断开重连的开关, 默认开启
 * @property {Boolean} isRestart 标识是否正在尝试开始重新连接 默认false
 * @property {Function} openHandles 标识连接打开时的执行函数
 */
function webSocketLib(opts) {
  utils.extend(this, socketDefaults, opts);
  this._socket = this._socket.toLowerCase();
  this._socket = this._socket.indexOf('ws://') == -1 ? `ws://${this._socket}` : this._socket;
  this._socket = this._socket.split(':').length &lt; 3 ? `${this._socket}:6700` : this._socket;
}

webSocketLib.prototype = {
  /**
   * 构造函数,指向webSocketLib
   */
  constructor: webSocketLib,
  /**
   * 注册事件回调
   * @param {String} eventName 事件名称 可选值：onopen / onmessage / onerror / onclose
   * @param {Function} callback 回调函数
   */
  on: function (eventName, callback) {
    if (!this.handles) {
      this.handles = {};
    }
    (this.handles[eventName] || (this.handles[eventName] = [])).push(callback);
  },
  /**
   * 触发事件回调函数
   * @param {String} eventName 事件名称
   * @param {Object} args 触发回调函数传参
   */
  fire: function (eventName, args) {
    if (this.handles &amp;&amp; this.handles[eventName]) {
      for (let i = 0, _event; _event = this.handles[eventName][i]; i++) {
        try {
          _event(args);
        } catch (e) {
          console.log(`触发socket回调事件异常,事件名称: ${eventName}, 异常原因：`, e);
        }
      }
    }
  },
  /**
   * 初始化连接,并建立通信
   */
  init: function () {
    var _this = this;
    this._socket = new window.WebSocket(this._host);
    try {
      this.onopen = this.openHandles;
      this.onerror = function (evt) {
        console.log("[error]socket异常中止,重连", evt);
        _this._lockReconnect = false;
        _this.restart();
      }
      this.onclose = function (evt) {
        console.log("[close]socket关闭,重连", evt);
        _this._lockReconnect = false;
        _this.isRestart = false;
        _this.restart();
      }
    } catch (error) {
      console.log("socket捕获异常,重连", error);
      _this._lockReconnect = false;
      _this.isRestart = false;
      _this.restart();
    }
  },
  /**
   * 发送消息给服务器
   * @param {Object|String} data 向服务器发送的消息
   */
  send: function (data) {
    if (utils.isObject(data)) {
      data = JSON.stringify(data);
    }
    let i = 0;
    let timer = setInterval(function () {
      if (i > 3) {
        clearInterval(timer);
      }
      if (this._socket.readyState == window.WebSocket.OPEN) {
        this._socket.send(data);
        this.isRestart = fasle;
        clearInterval(timer);
      } else if (this._socket.readyState == window.WebSocket.CLOSED || this._socket.readyState == window.WebSocket.CLOSING) {
        clearInterval(timer);
      }
      i++;
    }, 500);
  },
  reconnect: function () {
    if (this._lockReconnect) return; //判断是否正在断线重连, 如正在进行断线重连,则退出,防止触发重连太频繁

    this._lockReconnect = true;
    this.init();
  },
  restart: function () {
    if (this.isRestart) {
      return;
    }
    this.isRestart = true;
    setTimeout(function () {
       console.log("正在尝试socket重连,请稍后...");
       reconnect();
    }, 2000);
  }
}


export let socket = {
  /**
   * 封装webSocket相关API
   * 支持断线重连、批量注册回调、二次通信等
   * @class
   * @property {Boolean} isReconnect 标识是否断开重连的开关, 默认开启
   * @property {Object} socket 标识socket实例
   * @property {String} host 标识需要连接的ws地址
   * @property {Array} handles 标识该连接已注册的回调事件列表
   */
  socket: {
  }
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Nov 09 2018 14:26:51 GMT+0800 (中国标准时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>

<script src="scripts/search.js"></script>




</body>
</html>
