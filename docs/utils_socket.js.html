<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>utils/socket.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="utils.html">utils</a><ul class='methods'><li data-type='method'><a href="utils.html#isObject">isObject</a></li><li data-type='method'><a href="utils.html#isArray">isArray</a></li><li data-type='method'><a href="utils.html#isDate">isDate</a></li><li data-type='method'><a href="utils.html#isNumber">isNumber</a></li><li data-type='method'><a href="utils.html#isInteger">isInteger</a></li><li data-type='method'><a href="utils.html#isString">isString</a></li><li data-type='method'><a href="utils.html#isBoolean">isBoolean</a></li><li data-type='method'><a href="utils.html#isFunction">isFunction</a></li><li data-type='method'><a href="utils.html#isNull">isNull</a></li><li data-type='method'><a href="utils.html#isNil">isNil</a></li><li data-type='method'><a href="utils.html#isPlainObject">isPlainObject</a></li><li data-type='method'><a href="utils.html#hasOwn">hasOwn</a></li><li data-type='method'><a href="utils.html#unique">unique</a></li><li data-type='method'><a href="utils.html#extend">extend</a></li><li data-type='method'><a href="utils.html#freeze">freeze</a></li><li data-type='method'><a href="utils.html#copy">copy</a></li><li data-type='method'><a href="utils.html#getKeyValue">getKeyValue</a></li><li data-type='method'><a href="utils.html#setKeyValue">setKeyValue</a></li><li data-type='method'><a href="utils.html#toArray">toArray</a></li><li data-type='method'><a href="utils.html#toObject">toObject</a></li><li data-type='method'><a href="utils.html#uuid">uuid</a></li><li data-type='method'><a href="utils.html#getBrowser">getBrowser</a></li><li data-type='method'><a href="utils.html#getUriParams">getUriParams</a></li><li data-type='method'><a href="utils.html#getUriParamValue">getUriParamValue</a></li><li data-type='method'><a href="utils.html#saveLocal">saveLocal</a></li><li data-type='method'><a href="utils.html#getLocal">getLocal</a></li><li data-type='method'><a href="utils.html#getLocal2Json">getLocal2Json</a></li><li data-type='method'><a href="utils.html#removeLocal">removeLocal</a></li><li data-type='method'><a href="utils.html#saveCookie">saveCookie</a></li><li data-type='method'><a href="utils.html#getCookie">getCookie</a></li><li data-type='method'><a href="utils.html#removeCookie">removeCookie</a></li><li data-type='method'><a href="utils.html#clearCookie">clearCookie</a></li></ul></li><li><a href="utils.date.html">date</a><ul class='methods'><li data-type='method'><a href="utils.date.html#.format">format</a></li><li data-type='method'><a href="utils.date.html#.modDays">modDays</a></li><li data-type='method'><a href="utils.date.html#.modMinutes">modMinutes</a></li><li data-type='method'><a href="utils.date.html#.convertDateToTimeStamp">convertDateToTimeStamp</a></li><li data-type='method'><a href="utils.date.html#.convertTimeStampToDate">convertTimeStampToDate</a></li></ul></li><li><a href="utils.QT.html">QT</a><ul class='methods'><li data-type='method'><a href="utils.QT.html#.showLoading">showLoading</a></li></ul></li><li><a href="socket.html">socket</a></li><li><a href="utils.map.default.html">default</a><ul class='members'><li data-type='member'><a href="utils.map.default.html#._map">_map</a></li><li data-type='member'><a href="utils.map.default.html#.'Org'">'Org'</a></li><li data-type='member'><a href="utils.map.default.html#.'Rcu'">'Rcu'</a></li><li data-type='member'><a href="utils.map.default.html#.'Network'">'Network'</a></li><li data-type='member'><a href="utils.map.default.html#.'RingNet'">'RingNet'</a></li><li data-type='member'><a href="utils.map.default.html#.'Robot'">'Robot'</a></li><li data-type='member'><a href="utils.map.default.html#.'Smd'">'Smd'</a></li><li data-type='member'><a href="utils.map.default.html#.'70220002'">'70220002'</a></li><li data-type='member'><a href="utils.map.default.html#.'70220003'">'70220003'</a></li><li data-type='member'><a href="utils.map.default.html#.'70220004'">'70220004'</a></li></ul><ul class='methods'><li data-type='method'><a href="utils.map.default.html#.getIcon">getIcon</a></li><li data-type='method'><a href="utils.map.default.html#.setIcon">setIcon</a></li></ul></li><li><a href="utils.map.html">map</a><ul class='methods'><li data-type='method'><a href="utils.map.html#.initialize">initialize</a></li></ul></li><li><a href="utils.map.RData.html">RData</a><ul class='methods'><li data-type='method'><a href="utils.map.RData.html#initialize">initialize</a></li><li data-type='method'><a href="utils.map.RData.html#refreshDefaults">refreshDefaults</a></li><li data-type='method'><a href="utils.map.RData.html#_convertAttrs">_convertAttrs</a></li><li data-type='method'><a href="utils.map.RData.html#dataTreeToTable">dataTreeToTable</a></li><li data-type='method'><a href="utils.map.RData.html#dataListToTable">dataListToTable</a></li><li data-type='method'><a href="utils.map.RData.html#getDataBykey">getDataBykey</a></li><li data-type='method'><a href="utils.map.RData.html#getOnlyDataBykey">getOnlyDataBykey</a></li><li data-type='method'><a href="utils.map.RData.html#getDatas">getDatas</a></li></ul></li><li><a href="utils.map.RManager.html">RManager</a><ul class='methods'><li data-type='method'><a href="utils.map.RManager.html#addOverlay">addOverlay</a></li><li data-type='method'><a href="utils.map.RManager.html#addOverlays">addOverlays</a></li><li data-type='method'><a href="utils.map.RManager.html#removerOverlay">removerOverlay</a></li><li data-type='method'><a href="utils.map.RManager.html#removeOverlays">removeOverlays</a></li><li data-type='method'><a href="utils.map.RManager.html#removeViewingOverlay">removeViewingOverlay</a></li><li data-type='method'><a href="utils.map.RManager.html#removeViewingOverlays">removeViewingOverlays</a></li><li data-type='method'><a href="utils.map.RManager.html#clearOverlays">clearOverlays</a></li><li data-type='method'><a href="utils.map.RManager.html#clearViewingOverlays">clearViewingOverlays</a></li><li data-type='method'><a href="utils.map.RManager.html#getViewingOverlaysByZoom">getViewingOverlaysByZoom</a></li><li data-type='method'><a href="utils.map.RManager.html#show">show</a></li><li data-type='method'><a href="utils.map.RManager.html#hide">hide</a></li><li data-type='method'><a href="utils.map.RManager.html#toggle">toggle</a></li><li data-type='method'><a href="utils.map.RManager.html#getOverlayBykey">getOverlayBykey</a></li><li data-type='method'><a href="utils.map.RManager.html#getOverlays">getOverlays</a></li></ul></li><li><a href="utils.map.RMarker.html">RMarker</a><ul class='methods'><li data-type='method'><a href="utils.map.RMarker.html#_preRenderContent">_preRenderContent</a></li><li data-type='method'><a href="utils.map.RMarker.html#_convertThemeToString">_convertThemeToString</a></li><li data-type='method'><a href="utils.map.RMarker.html#_renderPresetStyles">_renderPresetStyles</a></li><li data-type='method'><a href="utils.map.RMarker.html#enableDragging">enableDragging</a></li><li data-type='method'><a href="utils.map.RMarker.html#disableDragging">disableDragging</a></li><li data-type='method'><a href="utils.map.RMarker.html#isDraggable">isDraggable</a></li><li data-type='method'><a href="utils.map.RMarker.html#getPosition">getPosition</a></li><li data-type='method'><a href="utils.map.RMarker.html#setPosition">setPosition</a></li><li data-type='method'><a href="utils.map.RMarker.html#getAnchor">getAnchor</a></li><li data-type='method'><a href="utils.map.RMarker.html#setAnchor">setAnchor</a></li><li data-type='method'><a href="utils.map.RMarker.html#getContent">getContent</a></li><li data-type='method'><a href="utils.map.RMarker.html#setContent">setContent</a></li><li data-type='method'><a href="utils.map.RMarker.html#getWidth">getWidth</a></li><li data-type='method'><a href="utils.map.RMarker.html#setWidth">setWidth</a></li><li data-type='method'><a href="utils.map.RMarker.html#getHeight">getHeight</a></li><li data-type='method'><a href="utils.map.RMarker.html#setHeight">setHeight</a></li><li data-type='method'><a href="utils.map.RMarker.html#on">on</a></li><li data-type='method'><a href="utils.map.RMarker.html#off">off</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-MapDesc.html">MapDesc</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">utils/socket.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>  let socketDefaults = {
    /**
     * 标识是否断开重连的开关, 默认开启
     */
    isReconnect: true,
    /**
     * 标识是否正在尝试开始重新连接
     */
    _isRestart: false,
    /**
     * 标识是否正在尝试重新连接
     */
    _lockReconnect: false,
    /**
     * 标识socket实例
     */
    _socket: null,
    /**
     * 标识需要连接的ws地址
     */
    _host: '',
    /**
     * 标识该连接已注册的回调事件列表
     */
    _handles: {},
    /**
     * 标识连接打开时的执行函数
     */
    openHandler: function () {

    }
  };

  /**
   * socket基类
   * @private
   * @param {Object} opts 
   * @property {Boolean} isReconnect 标识是否断开重连的开关, 默认开启
   * @property {Boolean} _isRestart 标识是否正在尝试开始重新连接 默认false
   * @property {Function} openHandler 标识连接打开时的执行函数
   */
  function webSocketLib(opts) {
    utils.extend(this, socketDefaults, opts);

    this._host = this._host.toLowerCase();
    this._host = this._host.indexOf('ws://') == -1 ? `ws://${this._host}` : this._host;
    this._host = this._host.split(':').length &lt; 3 ? `${this._host}:6700` : this._host;
  }

  webSocketLib.prototype = {
    /**
     * 构造函数,指向webSocketLib
     */
    constructor: webSocketLib,
    /**
     * 注册对象的事件监听器
     * @private
     * @param {String} type 事件类型 可选值：onopen / onmessage / onerror / onclose
     * @param {Function} handler 回调函数
     * @param {String} key 可选 为事件监听函数指定的名称，可在移除时使用。如果不提供，方法会默认为它生成一个全局唯一的key。
     */
    _on: function (type, handler, key) {
      if (!utils.isFunction(handler)) {
        console.log('请正确设置注册事件的回调函数 参数[handler]需要Function类型的值');
        return;
      }
      if (utils.isString(key) &amp;&amp; !!key.length) {
        if (/[^\w\-]/.test(key)) {
          //判断不是由字母、数字、下划线、中划线组成则抛出异常
          throw ("nonstandard key:" + key);
        } else {
          handler.hashCode = key;
        }
      }
      !this._handles &amp;&amp; (this._handles = {});
      type.indexOf('on') != 0 &amp;&amp; (type = 'on' + type);
      !utils.isObject(this._handles[type]) &amp;&amp; (this._handles[type] = {});
      key = key || utils.uuid();
      this._handles[type][key] = handler;
    },
    /**
     * 注销对象的事件监听器
     * @private
     * @param {String} type 事件类型 可选值：onopen / onmessage / onerror / onclose
     * @param {Function|String} handler 需要移除的事件监听函数或监听函数的key
     * @remark 如果第二个参数handler没有绑定到对应的事件中，则什么也不做
     */
    _off: function (type, handler) {
      if (!utils.isString(type) || !type.length) {
        console.log('请检查要移除的事件监听器类型是否正确');
        return;
      }
      if (utils.isFunction(handler)) {
        handler = handler.hashCode;
      } else if (!utils.isString(handler)) {
        return;
      }
      !this._handles &amp;&amp; (this._handles = {});
      type.indexOf('on') != 0 &amp;&amp; (type = 'on' + type);
      if (!this._handles[type]) {
        return;
      }
      this._handles[type][handler] &amp;&amp; delete this._handles[type][handler];
    },
    /**
     * 触发对象的事件监听器
     * @private
     * @param {String} type 事件类型
     * @param {Object} args 触发回调函数传参
     */
    _fire: function (type, args) {
      if (!utils.isString(type) || !type.length) {
        console.log('请检查要触发的事件监听器类型是否正确');
        return;
      }
      !this._handles &amp;&amp; (this._handles = {});
      type.indexOf('on') != 0 &amp;&amp; (type = 'on' + type);
      if (utils.isObject(this._handles[type])) {
        for (var key in this._handles[type]) {
          this._handles[type][key].call(this, args);
        }
      }
    },
    /**
     * 初始化连接,并建立通信
     * @private
     */
    _init: function () {
      var _this = this;
      try {
        this._socket = new window.WebSocket(this._host);
        this._socket.onopen = function () {
          _this.fire('onopen');
        };
        this._socket.onmessage = function (evt) {
          _this.fire('onmessage', evt.data);
        };
        this.onerror = function (evt) {
          console.log("[error]socket异常中止,重连", evt);
          _this.fire('onerror', evt);
          _this._lockReconnect = false;
          _this.restart();
        }
        this.onclose = function (evt) {
          console.log("[close]socket关闭,重连", evt);
          _this.fire('onerror', evt);
          _this._lockReconnect = false;
          _this._isRestart = false;
          _this.restart();
        }
      } catch (error) {
        console.log("socket捕获异常,重连", error);
        _this._lockReconnect = false;
        _this._isRestart = false;
        _this.restart();
      }
    },
    /**
     * 发送消息给服务器
     * @private
     * @param {Object|String} data 向服务器发送的消息
     */
    _send: function (data) {
      if (utils.isObject(data)) {
        data = JSON.stringify(data);
      }
      let i = 0;
      let timer = setInterval(function () {
        if (i++ > 3) {
          clearInterval(timer);
        }
        if (this._socket.readyState == window.WebSocket.OPEN) {
          this._socket.send(data);
          this._isRestart = fasle;
          clearInterval(timer);
        } else if (this._socket.readyState == window.WebSocket.CLOSED || this._socket.readyState == window.WebSocket.CLOSING) {
          clearInterval(timer);
        }
      }, 500);
    },
    /**
     * 断线重连
     * @private
     */
    _reconnect: function () {
      if (this._lockReconnect) return; //判断是否正在断线重连, 如正在进行断线重连,则退出,防止触发重连太频繁

      this._lockReconnect = true;
      this.init();
    },
    /**
     * 开始尝试断线重连
     * @private
     */
    _restart: function () {
      if (this.isReconnect == false) return;  //判断是否启用断线重连功能，若不启用，则退出
      if (this._isRestart) return; //判断是否正在尝试开始断线重连，如正在尝试开始断线重连，则退出，防止触发重连台频繁
      this._isRestart = true;
      setTimeout(function () {
        console.log("正在尝试socket重连,请稍后...");
        reconnect();
      }, 2000);
    }
  }


  /**
   * 初始化websocket
   * @class
   * @param {Json} opts socket初始化相关参数
   * @param {Boolean} opts.isReconnect 是否开启断线重连功能，默认开启 true
   * @param {String} opts.port 可选 websocket通讯地址端口号，默认 6700
   * @param {String} opts.host websocket 通讯地址 &lt;br /> &lt;span style="color: red;">如参数[host]中不包含协议名称和端口号，程序会自动添加协议名称和端口号&lt;/span>
   * @param {Array|Function} opts.openHandlers websocket通讯打开连接时触发执行的函数(数组)
   * @param {Array|Function} opts.messageHandlers 可选 websocket通讯消息回调时触发执行的函数(数组)
   */
  let socket = function (opts) {
    /**
     * 标识是否断开重连的开关, 默认开启 true
     * @private
     * @type {Boolean}
     */
    this._isReconnect = true;
    /**
     * 标识socket实例，默认 null
     * @private
     * @type {WebSocket|null}
     */
    this._socket = null;
    /**
     * 标识需要连接的ws地址端口号
     */
    this._port = '6700';
    /**
     * 标识需要连接的ws地址
     * @private
     * @type {String}
     */
    this._host = '';
    /**
     * 标识连接打开时的执行函数(数组)
     * @private
     * @type {Array|Function}
     */
    this._openHandlers = [];
    /**
     * 标识websocket接收消息的执行函数(数组)
     * @private
     * @type {Array|Function}
     */
    this.messageHandlers = [];

    this._opts = utils.extend({
      isReconnect: this._isReconnect,
      port: this._port,
      host: this._host,
      openHandlers: this._openHandlers,
      messageHandlers: this._messageHandlers
    }, opts);

    if(!(this instanceof socket)){
      throw ('使用该对象时，请使用关键字 "new"');
    }

    this._setPropertys();
  }
  /**
   * 检查参数类型是否正确并赋值给默认属性
   * @private
   * @returns {Boolean}
   */
  socket.prototype._setPropertys = function () {
    if (this._opts.isReconnect != undefined &amp;&amp; !utils.isBoolean(this._opts.isReconnect)) {
      throw('请检查参数[opts.isReconnect]的数据类型是否是boolean类型');
    }
    if (!utils.isString(this._opts.port) || !this._opts.port.length) {
      throw('请检查参数[opts.port]的数据类型是否是String类型');
    }
    if (!utils.isString(this._opts.host) || /^(?:(?:2[0-4][0-9]\.)|(?:25[0-5]\.)|(?:1[0-9][0-9]\.)|(?:[1-9][0-9]\.)|(?:[0-9]\.)){3}(?:(?:2[0-5][0-5])|(?:25[0-5])|(?:1[0-9][0-9])|(?:[1-9][0-9])|(?:[0-9]))$/.test(this._opts.host) == false) {
      throw('请检查参数[opts.port]的数据类型是否是String类型');
    }
  }

export let socketLib = { 
  socket: socket
 }

</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Nov 14 2018 20:20:31 GMT+0800 (中国标准时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>

<script src="scripts/search.js"></script>




</body>
</html>
